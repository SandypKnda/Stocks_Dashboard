<!DOCTYPE html>
<html>
<head>
  <title>ðŸ“ˆ Stock Treemap Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body>
  <h2>ðŸ“Š Interactive Stock Dashboard</h2>

  <!-- Filters -->
  <label for="type-select">Choose Type:</label>
  <select id="type-select">
    <option value="stock">Stocks</option>
    <option value="index">Indexes</option>
  </select>

  <label for="sub-filter-select" id="sub-label">Choose Sector:</label>
  <select id="sub-filter-select"></select>

  <!-- Chart Area -->
  <div id="treemap"></div>
  <div id="stock-details"></div>

  <script>
    const typeSelect = document.getElementById("type-select");
    const subFilter = document.getElementById("sub-filter-select");
    const subLabel = document.getElementById("sub-label");

    async function loadSubFilter(type) {
      const res = await fetch(`/api/filters?type=${type}`);
      const options = await res.json();
      subFilter.innerHTML = "";
      options.forEach(opt => {
        const el = document.createElement("option");
        el.value = opt;
        el.textContent = opt;
        subFilter.appendChild(el);
      });
    }

    async function loadChart(type, filter) {
      let url = `/api/stocks?type=${type}`;
      if (type === "stock") url += `&sector=${filter}`;
      else if (type === "index") url += `&index=${filter}`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data || data.length === 0) {
        document.getElementById("treemap").innerHTML = "âš ï¸ No data found.";
        return;
      }

      const labels = data.map(d => `${d.symbol} ($${d.price})`);
      const parents = data.map(d => d.sector || d.index || "Other");
      const values = data.map(d => d.price);
      const custom = data.map(d => `Predicted EOD: $${d.eod_prediction}`);

      const trace = {
        type: "treemap",
        labels, parents, values,
        textinfo: "label+value",
        hovertext: custom,
        hoverinfo: "text"
      };

      Plotly.newPlot("treemap", [trace]);

      document.getElementById("treemap").on("plotly_click", async evt => {
        const symbol = evt.points[0].label.split(" ")[0];
        const trendRes = await fetch(`/api/trend?symbol=${symbol}`);
        const trend = await trendRes.json();

        const videoRes = await fetch(`/api/video?symbol=${symbol}`);
        const { url: videoURL } = await videoRes.json();

        Plotly.newPlot("stock-details", [{
          x: trend.timestamps,
          y: trend.prices,
          type: "scatter",
          mode: "lines+markers",
          name: symbol
        }]);

        const details = document.getElementById("stock-details");
        const video = document.createElement("div");
        video.innerHTML = `<p>ðŸŽ¥ Analyst vlog:</p><a href="${videoURL}" target="_blank">${videoURL}</a>`;
        details.appendChild(video);
      });
    }

    typeSelect.addEventListener("change", async () => {
      const selectedType = typeSelect.value;
      subLabel.textContent = selectedType === "stock" ? "Choose Sector:" : "Choose Index:";
      await loadSubFilter(selectedType);
      loadChart(selectedType, subFilter.value);
    });

    subFilter.addEventListener("change", () => {
      loadChart(typeSelect.value, subFilter.value);
    });

    // Initial
    loadSubFilter("stock").then(() => {
      loadChart("stock", subFilter.value);
    });
  </script>
</body>
</html>
