<body>
  <h2>📈 Today's Top Performers</h2>

  <label for="type-select">Choose Type:</label>
  <select id="type-select">
    <option value="stocks">Stocks</option>
    <option value="indexes">Indexes</option>
  </select>

  <div id="sector-filter" style="display: block; margin-top: 10px;">
    <label for="sector-select">Select Sector:</label>
    <select id="sector-select">
      <option value="">All</option>
      <option value="Information Technology">Information Technology</option>
      <option value="Health Care">Health Care</option>
      <option value="Financials">Financials</option>
      <option value="Consumer Discretionary">Consumer Discretionary</option>
      <option value="Energy">Energy</option>
      <option value="Industrials">Industrials</option>
      <option value="Real Estate">Real Estate</option>
      <option value="Materials">Materials</option>
      <option value="Utilities">Utilities</option>
      <option value="Communication Services">Communication Services</option>
      <option value="Consumer Staples">Consumer Staples</option>
    </select>
  </div>

  <div id="index-filter" style="display: none; margin-top: 10px;">
    <label for="index-select">Select Index:</label>
    <select id="index-select">
      <option value="sp500">S&P 500</option>
      <option value="nasdaq100">NASDAQ-100</option>
      <option value="dowjones">Dow Jones</option>
    </select>
  </div>

  <div id="treemap" style="margin-top: 20px;"></div>

  <script>
    const typeSelect = document.getElementById("type-select");
    const sectorFilter = document.getElementById("sector-filter");
    const sectorSelect = document.getElementById("sector-select");
    const indexFilter = document.getElementById("index-filter");
    const indexSelect = document.getElementById("index-select");

    function loadChart(params = {}) {
      let url = "/api/stocks";
      const searchParams = new URLSearchParams(params);
      if (searchParams.toString()) {
        url += "?" + searchParams.toString();
      }

      fetch(url)
        .then(res => res.json())
        .then(data => {
          console.log("📊 STOCK DATA:", data);
          if (!data || data.length === 0) {
            document.getElementById("treemap").innerHTML = "⚠️ No valid data found.";
            return;
          }

          const labels = data.map(d => `${d.symbol} ($${d.price})`);
          const parents = data.map(d => d.sector || "Other");
          const values = data.map(d => d.price);
          const hover = data.map(d => `Predicted EOD: $${d.eod_prediction}`);

          const trace = {
            type: "treemap",
            labels: labels,
            parents: parents,
            values: values,
            textinfo: "label+value",
            hovertext: hover,
            hoverinfo: "text"
          };

          Plotly.newPlot('treemap', [trace]);
        })
        .catch(err => {
          console.error("❌ Error loading stock data:", err);
          document.getElementById("treemap").innerHTML = "⚠️ Error loading stock data.";
        });
    }

    // UI control logic
    typeSelect.addEventListener("change", () => {
      const selectedType = typeSelect.value;
      if (selectedType === "stocks") {
        sectorFilter.style.display = "block";
        indexFilter.style.display = "none";
        loadChart({ type: "stocks", sector: sectorSelect.value });
      } else if (selectedType === "indexes") {
        sectorFilter.style.display = "none";
        indexFilter.style.display = "block";
        loadChart({ type: "indexes", index: indexSelect.value });
      }
    });

    sectorSelect.addEventListener("change", () => {
      if (typeSelect.value === "stocks") {
        loadChart({ type: "stocks", sector: sectorSelect.value });
      }
    });

    indexSelect.addEventListener("change", () => {
      if (typeSelect.value === "indexes") {
        loadChart({ type: "indexes", index: indexSelect.value });
      }
    });

    // Initial load
    loadChart({ type: "stocks" });
  </script>
</body>
