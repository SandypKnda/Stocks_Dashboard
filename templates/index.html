<!DOCTYPE html>
<html>
<head>
  <title>Stock Treemap Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- ✅ Updated to latest Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body>
  <h2>📈 Today's Top Stocks by Sector</h2>

  <label for="sector-select">Select Sector:</label>
  <select id="sector-select">
    <option value="">All</option>
    <option value="Information Technology">Information Technology</option>
    <option value="Health Care">Health Care</option>
    <option value="Financials">Financials</option>
    <option value="Consumer Discretionary">Consumer Discretionary</option>
    <option value="Energy">Energy</option>
    <option value="Industrials">Industrials</option>
    <option value="Real Estate">Real Estate</option>
    <option value="Materials">Materials</option>
    <option value="Utilities">Utilities</option>
    <option value="Communication Services">Communication Services</option>
    <option value="Consumer Staples">Consumer Staples</option>
  </select>

  <div id="treemap" style="margin-top: 20px;"></div>

  <script>
    const sectorSelect = document.getElementById("sector-select");

    function loadChart(sector = "") {
      let url = "/api/stocks";
      if (sector) url += `?sector=${encodeURIComponent(sector)}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          console.log("📊 STOCK DATA:", data);

          if (!data || data.length === 0) {
            document.getElementById("treemap").innerHTML = "⚠️ No valid stock data found.";
            return;
          }

          const labels = data.map(d => `${d.symbol} ($${d.price})`);
          const parents = data.map(d => d.sector || "Other");
          const values = data.map(d => d.price);
          const custom = data.map(d => `Predicted EOD: $${d.eod_prediction}`);

          const trace = {
            type: "treemap",
            labels: labels,
            parents: parents,
            values: values,
            textinfo: "label+value",
            hovertext: custom,
            hoverinfo: "text"
          };

          Plotly.newPlot('treemap', [trace]);
        })
        .catch(err => {
          console.error("❌ Error loading stock data:", err);
          document.getElementById("treemap").innerHTML = "⚠️ Error loading stock data.";
        });
    }

    // Load chart initially
    loadChart();

    // Filter by sector
    sectorSelect.addEventListener("change", () => {
      const selectedSector = sectorSelect.value;
      loadChart(selectedSector);
    });
  </script>
</body>
</html>
